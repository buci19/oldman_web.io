<template>
    <!-- ç”¨æˆ·ä¸­å¿ƒä¸»å®¹å™¨ -->
    <div class="user-center">
        <!-- å¯¼èˆªæ  -->
        <header class="header">
            <div class="header-content">
                <img src="img/logo.png" alt="logo">
                <span class="header-title">oldman_healthy</span>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- ä¾§è¾¹æ  -->
            <aside class="sidebar">
                <!-- ç”¨æˆ·èµ„æ–™å±•ç¤ºåŒº -->
                <div class="user-profile">
                    <div class="avatar">
                        <img src="img/robot.png" alt="ç”¨æˆ·å¤´åƒ">
                    </div>
                    <div class="username">æ™ºéŸµå¤©æˆ</div>
                </div>

                <!-- å¯¼èˆªèœå• -->
                <nav class="nav-menu">
                    <button :class="['nav-item', { active: showSection === 'basicInfo' }]"
                        @click="showSection = 'basicInfo'">åŸºæœ¬èµ„æ–™</button>
                    <button :class="['nav-item', { active: showSection === 'changePassword' }]"
                        @click="showSection = 'changePassword'">ä¿®æ”¹å¯†ç </button>
                    <button :class="['nav-item', { active: showSection === 'aboutUs' }]"
                        @click="showSection = 'aboutUs'">å…³äºæˆ‘ä»¬</button>
                </nav>
            </aside>

            <!-- ä¸»è¦å†…å®¹åŒº -->
            <main class="content">
                <!-- åŸºæœ¬èµ„æ–™éƒ¨åˆ† -->
                <section v-if="showSection === 'basicInfo'" class="section-content">
                    <h2 class="section-title">åŸºæœ¬èµ„æ–™</h2>
                    <div class="form-content">
                        <!-- å·¦ä¾§åˆ— -->
                        <div class="form-column">
                            <div class="form-item">
                                <label>æ˜µç§°ï¼š</label>
                                <span v-text="username"></span>
                            </div>
                            <div class="form-item">
                                <label>æ‰‹æœºå·ï¼š</label>
                                <span v-text="phone"></span>
                            </div>
                            <div class="form-item">
                                <label>å¹´é¾„ï¼š</label>
                                <span v-text="age"></span>
                            </div>
                            <div class="form-item">
                                <label>èº«é«˜(cm)ï¼š</label>
                                <span v-text="height"></span>
                            </div>
                            <div class="form-item">
                                <label>ä½“é‡(kg)ï¼š</label>
                                <span v-text="weight"></span>
                            </div>
                            <div class="form-item">
                                <label>è¡€å‹ï¼š</label>
                                <span v-text="bloodType"></span>
                            </div>
                            <div class="form-item">
                                <label>ç­¾åï¼š</label>
                                <span v-text="faction"></span>
                            </div>
                        </div>

                        <!-- å³ä¾§åˆ— -->
                        <div class="form-column">
                            <div class="form-item">
                                <label>ç´§æ€¥è”ç³»äººï¼š</label>
                                <span v-text="emergencyContact"></span>
                            </div>
                            <div class="form-item">
                                <label>ç´§æ€¥ç”µè¯ï¼š</label>
                                <span v-text="emergencyPhone"></span>
                            </div>
                            <div class="form-item">
                                <label>è¿‡æ•å²ï¼š</label>
                                <span v-text="allergies"></span>
                            </div>
                            <div class="form-item">
                                <label>æ…¢æ€§ç—…å²ï¼š</label>
                                <span v-text="chronicDiseases"></span>
                            </div>
                            <div class="form-item">
                                <label>æ‰€åœ¨åœ°åŒºï¼š</label>
                                <span v-text="address"></span>
                            </div>
                            <div class="form-item">
                                <label>å…´è¶£çˆ±å¥½ï¼š</label>
                                <span v-text="hobbies"></span>
                            </div>
                        </div>
                    </div>
                    <div><button class="btn-primary" @click="handleClick('ç¼–è¾‘èµ„æ–™')">ç¼–è¾‘</button></div>
                </section>

                <!-- ä¿®æ”¹å¯†ç éƒ¨åˆ† -->
                <section v-if="showSection === 'changePassword'" class="section-content">
                    <h2 class="section-title">ä¿®æ”¹å¯†ç </h2>
                    <div class="password-form">
                        <!-- å¯†ç ä¿®æ”¹è¡¨å• -->
                        <div class="form-item">
                            <label>åŸå¯†ç ï¼š</label>
                            <input type="password" v-model="oldPassword" class="input">
                        </div>
                        <div class="form-item">
                            <label>æ–°å¯†ç ï¼š</label>
                            <input type="password" v-model="newPassword" class="input">
                        </div>
                        <div class="form-item">
                            <label>ç¡®è®¤å¯†ç ï¼š</label>
                            <input type="password" v-model="IsnewPassword" class="input">
                        </div>
                    </div>
                    <div><button class="btn-primary" @click="changePassword">ä¿å­˜</button></div>
                </section>

                <section v-if="showSection === 'aboutUs'" class="section-content about-us">
                    <h2 class="section-title">å…³äºæˆ‘ä»¬</h2>

                    <div class="about-content">
                        <!-- å…¬å¸ç®€ä»‹ -->
                        <div class="about-section">
                            <h3>å…¬å¸ç®€ä»‹</h3>
                            <p>æ™ºéŸµå¤©æˆè‡´åŠ›äºä¸ºè€å¹´äººæä¾›æ™ºèƒ½å¥åº·ç®¡ç†æœåŠ¡ï¼Œè®©ç§‘æŠ€å®ˆæŠ¤å¥åº·ã€‚</p>
                        </div>

                        <!-- æ ¸å¿ƒä»·å€¼è§‚ -->
                        <div class="about-section">
                            <h3>æ ¸å¿ƒä»·å€¼è§‚</h3>
                            <div class="values-grid">
                                <div class="value-item">
                                    <i class="value-icon">â¤ï¸</i>
                                    <p>å…³çˆ±ä¸ºæœ¬</p>
                                </div>
                                <div class="value-item">
                                    <i class="value-icon">ğŸ”¬</i>
                                    <p>ç§‘æŠ€åˆ›æ–°</p>
                                </div>
                                <div class="value-item">
                                    <i class="value-icon">ğŸ¤</i>
                                    <p>ä¸“ä¸šæœåŠ¡</p>
                                </div>
                            </div>
                        </div>

                        <!-- è”ç³»æˆ‘ä»¬ -->
                        <div class="about-section">
                            <h3>è”ç³»æˆ‘ä»¬</h3>
                            <div class="contact-info">
                                <p><i class="contact-icon">ğŸ“</i> 17507522648</p>
                                <p><i class="contact-icon">âœ‰ï¸</i> 2106476452@qq.com</p>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- å¯¹è¯æ¡†ç»„ä»¶ -->
        <dialog-component v-if="Visiable" ref="dialog" />
    </div>
</template>

<script>
// å¯¼å…¥å¯¹è¯æ¡†ç»„ä»¶
import dialogComponent from './dialogComponent.vue';

export default {
    name: 'UserCenter',

    // æ³¨å†Œç»„ä»¶
    components: {
        dialogComponent
    },

    // ç»„ä»¶æ•°æ®
    data() {
        return {
            showSection: 'basicInfo', // å½“å‰æ˜¾ç¤ºçš„éƒ¨åˆ†
            username: '', // ç”¨æˆ·å
            gender: '0', // æ€§åˆ«
            faction: '', // ç­¾å
            phone: '', // æ‰‹æœºå·
            address: '', // åœ°å€
            oldPassword: '', // åŸå¯†ç 
            newPassword: '', // æ–°å¯†ç 
            IsnewPassword: '', // ç¡®è®¤å¯†ç 
            Visiable: false, // å¯¹è¯æ¡†å¯è§æ€§
            hobbies: '', // å…´è¶£çˆ±å¥½
            age: '',
            height: '',
            weight: '',
            bloodType: '',
            emergencyContact: '',
            emergencyPhone: '',
            allergies: '',
            chronicDiseases: '',
        };
    },

    // ç”Ÿå‘½å‘¨æœŸé’©å­
    created() {
        this.initUserInfo(); // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
    },

    // ç»„ä»¶æ–¹æ³•
    methods: {
        // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
        async initUserInfo() {
            this.username = (localStorage.getItem('username') || 'é»˜è®¤ç”¨æˆ·å').replace(/['"]/g, '');
            this.gender = (localStorage.getItem('gender') || '0').replace(/['"]/g, '');
            this.faction = (localStorage.getItem('faction') || 'é»˜è®¤ç­¾å').replace(/['"]/g, '');
            this.phone = (localStorage.getItem('phone') || 'é»˜è®¤æ‰‹æœºå·').replace(/['"]/g, '');
            this.address = (localStorage.getItem('address') || 'é»˜è®¤åœ°å€').replace(/['"]/g, '');
            this.hobbies = (localStorage.getItem('hobbies') || 'æš‚æ— å…´è¶£çˆ±å¥½').replace(/['"]/g, '');
            this.age = (localStorage.getItem('age') || 'æœªè®¾ç½®').replace(/['"]/g, '');
            this.height = (localStorage.getItem('height') || 'æœªè®¾ç½®').replace(/['"]/g, '');
            this.weight = (localStorage.getItem('weight') || 'æœªè®¾ç½®').replace(/['"]/g, '');
            this.bloodType = (localStorage.getItem('bloodType') || 'æœªè®¾ç½®').replace(/['"]/g, '');
            this.emergencyContact = (localStorage.getItem('emergencyContact') || 'æœªè®¾ç½®').replace(/['"]/g, '');
            this.emergencyPhone = (localStorage.getItem('emergencyPhone') || 'æœªè®¾ç½®').replace(/['"]/g, '');
            this.allergies = (localStorage.getItem('allergies') || 'æ— ').replace(/['"]/g, '');
            this.chronicDiseases = (localStorage.getItem('chronicDiseases') || 'æ— ').replace(/['"]/g, '');
        },

        // å¤„ç†ç¼–è¾‘æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        handleClick(data) {
            this.Visiable = true;
            this.$nextTick(() => {
                this.$refs.dialog.init(data);
            });
        },

        // ä¿®æ”¹å¯†ç æ–¹æ³•
        async changePassword() {
            // è¡¨å•éªŒè¯
            if (!this.validatePasswordForm()) {
                return;
            }

            try {
                const id = localStorage.getItem('id');
                const response = await this.$axios.post(`/api/oldman/changePassword/${id}`, {
                    password: this.IsnewPassword
                });

                if (response.data.code === 200) {
                    this.$message.success('å¯†ç ä¿®æ”¹æˆåŠŸ');
                    this.resetPasswordForm();
                } else {
                    this.$message.error(response.data.message || 'å¯†ç ä¿®æ”¹å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿®æ”¹å¯†ç å¤±è´¥:', error);
                this.$message.error('å¯†ç ä¿®æ”¹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        },

        // éªŒè¯å¯†ç è¡¨å•
        validatePasswordForm() {
            if (!this.oldPassword || !this.newPassword || !this.IsnewPassword) {
                this.$message.warning('è¯·å¡«å†™å®Œæ•´çš„å¯†ç ä¿¡æ¯');
                return false;
            }

            if (this.newPassword !== this.IsnewPassword) {
                this.$message.warning('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
                return false;
            }

            if (this.newPassword.length < 6) {
                this.$message.warning('æ–°å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½');
                return false;
            }

            return true;
        },

        // é‡ç½®å¯†ç è¡¨å•
        resetPasswordForm() {
            this.oldPassword = '';
            this.newPassword = '';
            this.IsnewPassword = '';
        },

        // æ›´æ–°ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
        async updateUserInfo(data) {
            try {
                const id = localStorage.getItem('id');
                const response = await this.$axios.post(`/api/oldman/updateInfo/${id}`, data);

                if (response.data.code === 200) {
                    this.$message.success('ä¿¡æ¯æ›´æ–°æˆåŠŸ');
                    this.initUserInfo(); // é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯
                } else {
                    this.$message.error(response.data.message || 'ä¿¡æ¯æ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                console.error('æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                this.$message.error('ä¿¡æ¯æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
    },
    // ä¾¦å¬å™¨
    watch: {
        // ç›‘å¬æ€§åˆ«å˜åŒ–ï¼Œè‡ªåŠ¨ä¿å­˜åˆ°localStorage
        gender(newValue) {
            localStorage.setItem('gender', newValue);
        }
    }
};
</script>

<!-- æ ·å¼éƒ¨åˆ† -->
<style scoped>
/* å…¨å±€ç¦ç”¨æ»šåŠ¨æ¡ */
* {
    scrollbar-width: none;
    /* Firefox */
    -ms-overflow-style: none;
    /* IE and Edge */
}

/* Chrome, Safari and Opera */
*::-webkit-scrollbar {
    display: none;
}

.about-content {
    max-width: 800px;
    margin: 0 auto;
    height: auto;
    /* è‡ªé€‚åº”é«˜åº¦ */
}

.about-section {
    margin-bottom: 2rem;
}

.about-section h3 {
    color: #333;
    margin-bottom: 1rem;
}

.values-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    margin: 1rem 0;
}

.value-item {
    text-align: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.value-icon {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.contact-info {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.contact-info p {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.contact-icon {
    font-size: 1.2rem;
}

/* ä¸Šé¢æ˜¯å…³äºæˆ‘ä»¬æ ·å¼ */

/* ç”¨æˆ·ä¸­å¿ƒå®¹å™¨æ ·å¼ */
.user-center {
    min-height: 100vh;
    background: linear-gradient(200deg, #e3c5eb, #a9c1ed);
    overflow: hidden;
}

/* å¤´éƒ¨æ ·å¼ */
.header {
    background: linear-gradient(200deg, #97bbfd, #f2c2ff);
    padding: 1rem;
}

/* å¤´éƒ¨å†…å®¹æ ·å¼ */
.header-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: 1rem;
}

/* å¤´éƒ¨å›¾ç‰‡æ ·å¼ */
.header img {
    width: 40px;
    height: 40px;
}

/* ä¸»è¦å†…å®¹åŒºåŸŸæ ·å¼ */
.main-content {
    max-width: 1200px;
    margin: 2rem auto;
    display: flex;
    gap: 2rem;
    min-height: calc(100vh - 200px);
    /* è®¾ç½®æœ€å°é«˜åº¦ */
    overflow: hidden;
}

/* ä¾§è¾¹æ æ ·å¼ */
.sidebar {
    width: 250px;
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    height: calc(100vh - 200px);
    /* ä¸contentä¿æŒä¸€è‡´ */
    overflow: hidden;
}

/* ç”¨æˆ·èµ„æ–™æ ·å¼ */
.user-profile {
    text-align: center;
    margin-bottom: 2rem;
}

/* å¤´åƒå®¹å™¨æ ·å¼ */
.avatar {
    width: 120px;
    height: 120px;
    margin: 0 auto 1rem;
    border-radius: 50%;
    overflow: hidden;
    background: #f0f0f0;
}

/* å¤´åƒå›¾ç‰‡æ ·å¼ */
.avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* å¯¼èˆªèœå•æ ·å¼ */
.nav-menu {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    /* åˆ é™¤å›ºå®šé«˜åº¦ */
}

/* å¯¼èˆªé¡¹æ ·å¼ */
.nav-item {
    padding: 0.8rem 1rem;
    border: none;
    background: none;
    text-align: left;
    font-size: 1rem;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.3s;
}

/* å¯¼èˆªé¡¹æ‚¬åœå’Œæ¿€æ´»çŠ¶æ€æ ·å¼ */
.nav-item:hover,
.nav-item.active {
    background: #f0f0f0;
    color: #6b9fff;
}

/* å†…å®¹åŒºæ ·å¼ */
.content {
    flex: 1;
    background: white;
    border-radius: 8px;
    padding: 2rem;
    min-height: 600px;
    /* è®¾ç½®æœ€å°é«˜åº¦ */
    height: calc(100vh - 200px);
    /* è®¾ç½®æœ€å¤§é«˜åº¦ï¼Œå‡å»å¤´éƒ¨å’Œè¾¹è·çš„é«˜åº¦ */
    overflow: hidden;
}

/* åŒºå—æ ‡é¢˜æ ·å¼ */
.section-title {
    margin-bottom: 2rem;
    font-size: 1.5rem;
    color: #333;
}

/* è¡¨å•å†…å®¹æ ·å¼ */
.form-content {
    display: flex;
    gap: 2rem;
    max-width: 100%;
    margin-bottom: 2rem;
    height: auto;
    /* è‡ªé€‚åº”é«˜åº¦ */
}

.form-column {
    flex: 1;
    min-width: 0;
    line-height: 40px;
    /* é˜²æ­¢å†…å®¹æº¢å‡º */
}

/* è¡¨å•é¡¹æ ·å¼ */
.form-item {
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
}

/* è¡¨å•æ ‡ç­¾æ ·å¼ */
.form-item label {
    min-width: 100px;
    color: #666;
    flex-shrink: 0;
    /* é˜²æ­¢æ ‡ç­¾è¢«å‹ç¼© */
}

.form-item span {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    /* æ–‡æœ¬è¿‡é•¿æ—¶æ˜¾ç¤ºçœç•¥å· */
    white-space: nowrap;
}

/* è¾“å…¥æ¡†æ ·å¼ */
.input {
    flex: 1;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
}

/* å•é€‰æ¡†æ ·å¼ */
.radio {
    margin-right: 1rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

/* ä¸»è¦æŒ‰é’®æ ·å¼ */
.btn-primary {
    background: #6b9fff;
    color: white;
    border: none;
    padding: 0.8rem 2rem;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s;
    position: absolute;
    top: 0px;
    right: 20px;
}

.section-content {
    position: relative;
    height: 100%;
    /* ç»§æ‰¿çˆ¶å®¹å™¨é«˜åº¦ */
    padding: 2rem;
}

/* ä¸»è¦æŒ‰é’®æ‚¬åœæ ·å¼ */
.btn-primary:hover {
    background: #5a8ae6;
}

/* ä¿®æ”¹å¯†ç è¡¨å•æ ·å¼ */
.password-form {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    max-width: 400px;
    margin: 0 auto;
    line-height: 80px;
}

.password-form .form-item {
    margin-bottom: 0;
}
</style>